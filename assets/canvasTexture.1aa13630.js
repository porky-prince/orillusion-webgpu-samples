import"./modulepreload-polyfill.b7f2da20.js";import{b as G}from"./basic.vert.9475eb7d.js";import{i as U}from"./imageTexture.frag.b24f2b53.js";import{v as P,a as B}from"./cube.aa091a3d.js";import{b as C}from"./math.cb05c6db.js";async function S(e){if(!navigator.gpu)throw new Error("Not Support WebGPU");const t=await navigator.gpu.requestAdapter();if(!t)throw new Error("No Adapter Found");const r=await t.requestDevice(),n=e.getContext("webgpu"),s=navigator.gpu.getPreferredCanvasFormat?navigator.gpu.getPreferredCanvasFormat():n.getPreferredFormat(t),a=window.devicePixelRatio||1;e.width=e.clientWidth*a,e.height=e.clientHeight*a;const o={width:e.width,height:e.height};return n.configure({device:r,format:s,compositingAlphaMode:"opaque"}),{device:r,context:n,format:s,size:o}}async function R(e,t,r){const n=await e.createRenderPipelineAsync({label:"Basic Pipline",layout:"auto",vertex:{module:e.createShaderModule({code:G}),entryPoint:"main",buffers:[{arrayStride:20,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:12,format:"float32x2"}]}]},fragment:{module:e.createShaderModule({code:U}),entryPoint:"main",targets:[{format:t}]},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}}),s=e.createTexture({size:r,format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}),a=e.createBuffer({label:"GPUBuffer store vertex",size:P.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});e.queue.writeBuffer(a,0,P);const o=e.createBuffer({label:"GPUBuffer store 4x4 matrix",size:4*4*4,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),f=e.createBindGroup({label:"Uniform Group with Matrix",layout:n.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:o}}]});return{pipeline:n,vertexBuffer:a,mvpBuffer:o,uniformGroup:f,depthTexture:s}}function A(e,t,r,n){const s=e.createCommandEncoder(),a={colorAttachments:[{view:t.getCurrentTexture().createView(),clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:r.depthTexture.createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}},o=s.beginRenderPass(a);o.setPipeline(r.pipeline),o.setBindGroup(0,r.uniformGroup),o.setBindGroup(1,n),o.setVertexBuffer(0,r.vertexBuffer),o.draw(B),o.end(),e.queue.submit([s.finish()])}async function M(){const e=document.querySelector("canvas#webgpu"),t=document.querySelector("canvas#canvas");if(!e||!t)throw new Error("No Canvas");const{device:r,context:n,format:s,size:a}=await S(e),o=await R(r,s,a),f=[t.width,t.height],g=r.createTexture({size:f,format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT}),E=r.createSampler({magFilter:"linear",minFilter:"linear"}),v=r.createBindGroup({label:"Texture Group with Texture/Sampler",layout:o.pipeline.getBindGroupLayout(1),entries:[{binding:0,resource:E},{binding:1,resource:g.createView()}]});let m=a.width/a.height;const b={x:0,y:0,z:-5},y={x:1,y:1,z:1},l={x:0,y:0,z:0};function x(){const i=Date.now()/1e3;l.x=Math.sin(i),l.y=Math.cos(i);const u=C(m,b,l,y);r.queue.writeBuffer(o.mvpBuffer,0,u.buffer),r.queue.copyExternalImageToTexture({source:t},{texture:g},f),A(r,n,o,v),requestAnimationFrame(x)}requestAnimationFrame(x),window.addEventListener("resize",()=>{a.width=e.width=e.clientWidth*devicePixelRatio,a.height=e.height=e.clientHeight*devicePixelRatio,o.depthTexture.destroy(),o.depthTexture=r.createTexture({size:a,format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}),m=a.width/a.height});{const i=t.getContext("2d");if(!i)throw new Error("No support 2d");i.fillStyle="#fff",i.lineWidth=5,i.lineCap="round",i.lineJoin="round",i.fillRect(0,0,t.width,t.height);let u=!1,p=0,h=0,d=0;t.addEventListener("pointerdown",c=>{u=!0,p=c.offsetX,h=c.offsetY}),t.addEventListener("pointermove",c=>{if(!u)return;const w=c.offsetX,T=c.offsetY;d=d>360?0:d+1,i.strokeStyle=`hsl(${d}, 90%, 50%)`,i.beginPath(),i.moveTo(p,h),i.lineTo(w,T),i.stroke(),p=w,h=T}),t.addEventListener("pointerup",()=>u=!1),t.addEventListener("pointerout",()=>u=!1)}}M();
